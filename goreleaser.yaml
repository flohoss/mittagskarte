version: 2

env:
  - IMAGE_NAME=ghcr.io/flohoss/mittagskarte

before:
  hooks:
    - go install github.com/a-h/templ/cmd/templ@latest
    - templ generate

builds:
  - env:
      - CGO_ENABLED=1
    ldflags:
      - -s -w
    goos:
      - linux
    goarch:
      - amd64

dockers:
  - use: buildx
    dockerfile: docker/goreleaser.dockerfile
    goos: linux
    goarch: amd64
    image_templates:
      - '{{ .Env.IMAGE_NAME }}:latest'
      - '{{ .Env.IMAGE_NAME }}:v{{ .Major }}'
      - '{{ .Env.IMAGE_NAME }}:{{ .Tag }}'
    build_flag_templates:
      - '--build-arg=DATE={{ .Date }}'
      - '--build-arg=VERSION={{ .Tag }}'
      - '--build-arg=REPO={{ .Env.REPO }}'
      - '--platform=linux/amd64'
      - --label=org.opencontainers.image.title={{ .ProjectName }}
      - --label=org.opencontainers.image.description={{ .ProjectName }}
      - --label=org.opencontainers.image.version={{ .Version }}
      - --label=org.opencontainers.image.created={{ time "2006-01-02T15:04:05Z07:00" }}
      - --label=org.opencontainers.image.revision={{ .FullCommit }}
    extra_files:
      - views/
      - package.json
      - yarn.lock
      - assets/

docker_manifests:
  - name_template: '{{ .Env.IMAGE_NAME }}:{{ .Tag }}'
    image_templates:
      - '{{ .Env.IMAGE_NAME }}:{{ .Tag }}'
  - name_template: '{{ .Env.IMAGE_NAME }}:v{{ .Major }}'
    image_templates:
      - '{{ .Env.IMAGE_NAME }}:v{{ .Major }}'
  - name_template: '{{ .Env.IMAGE_NAME }}:latest'
    image_templates:
      - '{{ .Env.IMAGE_NAME }}:latest'

changelog:
  sort: asc
  filters:
    exclude:
      - '^docs:'
      - '^test:'

archives:
  - formats: ['none']

release:
  skip_upload: true
