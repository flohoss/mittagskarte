{{ define "title" }}
  {{ .BaseData.Title }}
{{ end }}

{{ define "style" }}
  {{ $version := env "APP_VERSION" }}
  {{ $mapLink := printf "/storage/public/maps/%s.webp?%s" .RestaurantData.Restaurant.ID $version }}
  <style>
    .map-img {
      background: url("{{ $mapLink }}") center/cover no-repeat;
      position: relative;
      border-radius: 0.5rem;
      height: 100%;
      width: 100%;
    }

    .map-img::before,
    .map-img::after {
      content: "";
      position: absolute;
      top: 0;
      bottom: 0;
      width: 50%;
      background: linear-gradient(to right, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0));
      border-radius: 0.5rem;
    }

    .map-img::after {
      right: 0;
      left: auto;
      background: linear-gradient(to left, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0));
    }
  </style>
{{ end }}

{{ define "content" }}
  {{ $restDay := isRestDay .RestaurantData.Restaurant }}
  <div
    class="{{ if $restDay }}
      grayscale opacity-50 animate-fadeIn50
    {{ else }}
      animate-fadeIn
    {{ end }} container flex flex-col justify-start h-screen gap-6 py-1 md:py-5"
  >
    {{ $nothingFound := nothingFound .RestaurantData.Card }}
    {{ if or $restDay $nothingFound }}
      <div class="z-40 -rotate-12 absolute top-14 left-1/2 transform -translate-x-1/2">
        {{ if $restDay }}
          <div class="alert alert-warning shadow-lg">
            <svg class="icon"><use href="#info"></use></svg>
            <span>Heute Ruhetag</span>
          </div>
        {{ end }}
      </div>
    {{ end }}
    <header class="h-[9rem]">
      <figure class="map-img">
        <div class="flex flex-col gap-2 items-start absolute left-4 bottom-3 z-30">
          {{ if and .RestaurantData.Card.ImageURL .RestaurantData.Card.Food }}
            <button onclick="my_modal.showModal()" class="btn btn-sm btn-primary gap-2">
              <svg class="inline-block w-4 h-4 stroke-current"><use href="#menu"></use></svg> Speisekarte
            </button>
          {{ end }}
          <a target="_blank" class="btn btn-sm btn-secondary gap-2" href="{{ .RestaurantData.Restaurant.PageURL }}">
            <svg class="inline-block w-4 h-4 stroke-current"><use href="#external"></use></svg> Webseite
          </a>
          <a href="tel:{{ .RestaurantData.Restaurant.Phone }}" class="btn btn-sm btn-secondary gap-2">
            <svg class="inline-block w-4 h-4 stroke-current"><use href="#phone"></use></svg> {{ .RestaurantData.Restaurant.Phone }}
          </a>
        </div>
        <div class="hidden md:flex flex-col gap-2 items-end absolute right-4 bottom-3 z-30">
          <div class="badge badge-lg gap-2">
            {{ .RestaurantData.Updated }} <svg class="inline-block w-4 h-4 stroke-current"><use href="#scan"></use></svg>
          </div>
          <div class="badge badge-lg gap-2">
            {{ .RestaurantData.Refreshed }} <svg class="inline-block w-4 h-4 stroke-current"><use href="#save"></use></svg>
          </div>
          {{ if eq .RestaurantData.Restaurant.Group 1 }}
            <div class="badge badge-lg gap-2">
              {{ .RestaurantData.Card.Distance }} <svg class="inline-block w-4 h-4 stroke-current"><use href="#sign"></use></svg>
            </div>
            <div class="badge badge-lg gap-2">
              {{ .RestaurantData.Card.Duration }} <svg class="inline-block w-4 h-4 stroke-current"><use href="#car"></use></svg>
            </div>
          {{ end }}
        </div>
      </figure>
    </header>

    <main class="flex-1 overflow-hidden">
      {{ if .RestaurantData.Card.Food }}
        <div class="grid gap-4 max-h-full overflow-y-auto">
          <div class="text-3xl font-bold ml-4">{{ .RestaurantData.Card.Description }}</div>
          {{ range .RestaurantData.Card.Food }}
            {{ $today := isToday . }}
            {{ $notRestDay := not $restDay }}
            <div class="{{ if and $today $notRestDay }}food-card{{ else }}food-card-disabled{{ end }} overflow-hidden">
              <div class="overflow-hidden">
                {{ if .Day }}<div class="text-sm">{{ .Day }}</div>{{ end }}
                <div class="font-bold text-lg">{{ .Name }}</div>
                {{ if .Description }}<div class="text-sm">{{ .Description }}</div>{{ end }}
              </div>
              {{ if .Price }}
                {{ $price := printf "%.2f" .Price }}
                {{ $price := $price | replace "." "," }}
                <div class="price badge badge-lg badge-primary whitespace-nowrap">{{ $price }} €</div>
              {{ end }}
            </div>
          {{ end }}
        </div>
      {{ else if .RestaurantData.Card.ImageURL }}
        {{ $sizes := imageSize .RestaurantData.Card.ImageURL }}
        {{ $height := index $sizes 0 }}
        {{ $width := index $sizes 1 }}
        <img width="{{ $width }}" height="{{ $height }}" class="object-contain object-center rounded-lg" src="/{{ .RestaurantData.Card.ImageURL }}" />
      {{ else if $nothingFound }}
        <div class="h-screen flex justify-start items-center text-gray-500">Kein Mittagstisch gefunden</div>
      {{ end }}
    </main>
  </div>
{{ end }}

{{ define "modal" }}
  {{ if .RestaurantData.Card.ImageURL }}
    {{ $sizes := imageSize .RestaurantData.Card.ImageURL }}
    {{ $height := index $sizes 0 }}
    {{ $width := index $sizes 1 }}
    <dialog id="my_modal" class="modal">
      <form method="dialog" class="modal-box p-0 max-w-6xl">
        <img width="{{ $width }}" height="{{ $height }}" class="rounded-lg w-full" src="/{{ .RestaurantData.Card.ImageURL }}" />
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
      </form>
      <form method="dialog" class="modal-backdrop">
        <button>close</button>
      </form>
    </dialog>
  {{ end }}
{{ end }}

{{ define "js" }}
  <script>
    const SETTINGS_LOCAL_STORAGE = 'mittag_settings';

    let priceReduction = 0;
    const prices = document.querySelectorAll('.price');
    const ls = localStorage.getItem(SETTINGS_LOCAL_STORAGE);
    if (ls) {
      const parsed = JSON.parse(ls);
      priceAdjustment = parsed.priceAdjustment;
      for (price of prices) {
        const parsedPrice = parseFloat(price.innerText.replace(',', '.'));
        price.innerText = (parsedPrice - priceAdjustment).toFixed(2).replace('.', ',') + ' €';
      }
    }
  </script>
{{ end }}
